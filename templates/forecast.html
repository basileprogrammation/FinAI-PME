{% extends 'base.html' %}

{% block content %}
<div class="p-6">
  <h2 class="text-2xl font-bold mb-4">üîÆ Pr√©vision de Tr√©sorerie (IA)</h2>

  {% if alerte %}
    <div class="bg-red-100 text-red-700 p-4 rounded mb-4 shadow">
      ‚ö†Ô∏è Attention : la pr√©vision IA d√©tecte un risque de solde n√©gatif dans les 30 prochains jours.
    </div>
    <div class="bg-green-100 text-green-800 p-4 rounded shadow mb-6">
        <h3 class="text-lg font-semibold mb-2">üí° Conseil personnalis√© FinAI</h3>
        <p>{{ conseil }}</p>
    </div>
  {% endif %}

  {% if historique and prevision %}
    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
      <div class="bg-green-100 text-green-800 p-4 rounded shadow">
        <h4 class="font-bold text-lg">Total Revenus</h4>
        <p class="text-2xl">{{ total_revenus }} ‚Ç¨</p>
      </div>
      <div class="bg-red-100 text-red-800 p-4 rounded shadow">
        <h4 class="font-bold text-lg">Total D√©penses</h4>
        <p class="text-2xl">{{ total_depenses }} ‚Ç¨</p>
      </div>
      <div class="bg-purple-100 text-purple-800 p-4 rounded shadow">
        <h4 class="font-bold text-lg">Solde Pr√©vu (30j)</h4>
        <p class="text-2xl flex items-center gap-2">
          {{ solde_prevu }} ‚Ç¨
          <span class="text-sm font-medium">{{ tendance }}</span>
        </p>
      </div>
      <div class="p-4 rounded shadow {{ sante.class }}">
        <h4 class="font-bold text-lg">Sant√© financi√®re</h4>
        <p class="text-xl">{{ sante.label }}</p>
      </div>
    </div>

    <canvas id="forecastChart" class="w-full bg-white p-4 rounded shadow"></canvas>

  {% else %}
    <p class="text-gray-600">Pas encore assez de donn√©es pour g√©n√©rer une pr√©vision.</p>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const historiqueData = {{ historique | default([]) | tojson }};
  const previsionData = {{ prevision | default([]) | tojson }};

  const labels = historiqueData.map(d => d.day).concat(previsionData.map(d => d.day));

  const revenus = historiqueData.map(d => d.type === 'revenu' ? d.value : null);
  const depenses = historiqueData.map(d => d.type === 'depense' ? d.value : null);
  const previsionValues = Array(historiqueData.length).fill(null).concat(previsionData.map(d => d.value));

  const ctx = document.getElementById('forecastChart');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          type: 'bar',
          label: 'Revenus (‚Ç¨)',
          data: revenus,
          backgroundColor: 'rgba(34,197,94,0.7)' // vert
        },
        {
          type: 'bar',
          label: 'D√©penses (‚Ç¨)',
          data: depenses,
          backgroundColor: 'rgba(239,68,68,0.7)' // rouge
        },
        {
          type: 'line',
          label: 'Pr√©vision IA (‚Ç¨)',
          data: previsionValues,
          borderColor: 'purple',
          borderDash: [5, 5],
          tension: 0.3,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>
{% endblock %}
